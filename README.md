# 计算机视觉项目集合

基于OpenCV的计算机视觉系统，包含产品质量检测和公式识别两个任务。

## 项目概述

本系统实现了两个计算机视觉任务：
1. **任务1：流水线产品识别** ✅ - 检测视频中从右向左移动的PCB板，分类为合格品（矩形）或次品（三角形）
2. **任务2：公式识别** ✅ - 识别图片中的数学公式并计算结果

## 功能特点

- 实时检测和分类PCB产品（合格品/次品）
- 自动跟踪产品避免重复计数
- 检测产品的旋转角度和缩放比例
- 实时输出检测结果
- 最终统计报告

## 检测结果

### 视频1 (video/1.mp4)
- 合格品：3个
- 次品：3个
- 总计：6个

### 视频2 (video/2.mp4)
- 合格品：4个
- 次品：2个
- 总计：6个

## 使用方法

### 编译

```bash
mkdir build
cd build
cmake ..
make
```

### 任务1: 运行流水线产品检测

```bash
# 从build目录运行（基本模式）
./conveyor_inspection_cli

# 保存调试帧（会在output_1/和output_2/目录保存带检测标注的图像）
./conveyor_inspection_cli --save-frames
```

### 任务2: 运行公式识别

```bash
# 从build目录运行
./formula_recognition_cli ../formula_images/formula_1.png

# 启用调试模式
./formula_recognition_cli ../formula_images/formula_1.png --debug
```

### 依赖

- OpenCV 4.x
- C++11或更高版本
- CMake 3.10或更高版本

### 说明

- 命令行版本，无需GUI支持，适合在WSL或服务器环境运行
- 实时输出中文检测信息到控制台
- 使用 `--save-frames` 参数会保存带检测标注的图像帧用于调试

## 技术实现

### 检测算法

1. **颜色检测**
   - 使用HSV颜色空间检测绿色PCB板
   - 颜色范围：H(35-85), S(40-255), V(40-255)

2. **形状分类**
   - 矩形PCB → 合格品
   - 三角形PCB → 次品
   - 使用轮廓近似和凸包分析

3. **产品跟踪**
   - 基于质心的距离跟踪
   - 防止重复计数
   - 设置计数线（左侧20%位置）

4. **旋转和缩放检测**
   - 使用minAreaRect获取旋转矩形
   - 计算角度和缩放因子
   - 参考尺寸：200像素

### 关键参数

- **颜色范围**：绿色HSV值 (35-85, 40-255, 40-255)
- **最小面积**：1000像素
- **跟踪距离阈值**：80像素
- **计数线位置**：画面宽度的20%
- **匹配距离阈值**：50像素

## 项目结构

```
.
├── conveyor_inspection_cli.cpp     # C++ CLI实现（主程序）
├── CMakeLists.txt                  # CMake构建配置
├── video/                          # 视频文件目录
│   ├── 1.mp4
│   └── 2.mp4
├── 要求/                           # 项目需求文档
│   ├── 1.jpg
│   └── 2.jpg
├── build/                          # 编译输出目录（由cmake生成）
│   ├── conveyor_inspection_cli     # CLI可执行文件
│   ├── output_1/                   # 视频1调试帧输出（--save-frames时生成）
│   └── output_2/                   # 视频2调试帧输出（--save-frames时生成）
├── README.md                       # 本文件
├── CLAUDE.md                       # Claude Code项目说明
└── .gitignore                      # Git忽略规则
```

## 扩展功能

已实现的扩展需求：
- ✅ 处理旋转和缩放变化
- ✅ 输出旋转角度和缩放倍数
- ✅ 实时输出检测结果
- ✅ 快速识别（30fps处理速度）
- ✅ 支持多种分辨率

## 性能

- 视频1 (852x344): 处理311帧，约10.4秒
- 视频2 (1216x720): 处理421帧，约14.0秒
- 实时处理速度：30fps

## 输出示例

```
============================================================
Processing: video/1.mp4
============================================================

Frame 82: DEFECTIVE detected - Angle: 90.0°, Scale: 1.09x | Qualified: 0, Defective: 1
Frame 99: QUALIFIED detected - Angle: 90.0°, Scale: 1.34x | Qualified: 1, Defective: 1
Frame 173: QUALIFIED detected - Angle: 90.0°, Scale: 1.29x | Qualified: 2, Defective: 1
...

============================================================
FINAL STATISTICAL REPORT
============================================================
Video: video/1.mp4
------------------------------------------------------------
Qualified Products: 3
Defective Products: 3
Total Products:     6
============================================================
```

---

# 任务2: 公式识别系统

## 功能说明

基于OpenCV的数学公式识别系统，可以从图片中识别数学表达式并计算结果。

### 支持的功能

**基础任务**:
- ✅ 识别阿拉伯数字 (0-9)
- ✅ 识别基本运算符 (+, -, ×, ÷, =)
- ✅ 输出识别的公式内容
- ✅ 计算并输出结果

**扩展任务**:
- ⚠️ 识别多个公式 (部分支持)
- ⚠️ 识别旋转的公式 (算法已实现,精度有限)
- ❌ 识别复杂嵌套公式 (需深度学习模型)
- ❌ 识别复合运算符 (需专业OCR引擎)

## 使用方法

### 运行公式识别

```bash
# 从build目录运行
./formula_recognition_cli ../formula_images/formula_1.png

# 启用调试模式(会保存二值化图像到debug_binary.png)
./formula_recognition_cli ../formula_images/formula_1.png --debug
```

### 测试图片

项目提供了6张测试图片在 `formula_images/` 目录:
- formula_1.png: 12+34=46
- formula_2.png: 56-23=33
- formula_3.png: 8×9=72
- formula_4.png: 100÷5=20
- formula_5.png: 3+5×2=13
- formula_6.png: 45-12+8=41

## 技术实现

### 识别流程

1. **图像预处理**
   - 灰度化转换
   - 自适应阈值二值化
   - 形态学去噪

2. **字符分割**
   - 轮廓检测
   - 边界框提取
   - 等号横线合并
   - 按x坐标排序

3. **字符识别**
   - 基于形态学特征的识别算法
   - 计算像素密度、宽高比、轮廓特征
   - 使用启发式规则进行字符分类

4. **公式解析和计算**
   - 运算符替换
   - 表达式求值
   - 结果验证

### 实现说明

本项目使用C++实现公式识别系统:

| 文件名 | 说明 |
|--------|------|
| `formula_recognition.cpp` | C++实现,基于形态学特征识别 |
| `formula_recognition_cli` | 编译后的可执行文件(在build/目录) |

## 依赖要求

- OpenCV 4.x
- C++11或更高版本
- CMake 3.10或更高版本

## 已知限制

### 当前版本的限制

1. **识别精度问题**
   - 基于形态学特征的识别方法精度有限
   - 只适用于清晰的打印体数字和简单运算符
   - 手写体、模糊图片、复杂排版的识别效果差
   - 不同字体可能导致识别错误

2. **功能限制**
   - 不支持分数、根号、指数等复杂运算符
   - 不支持括号嵌套
   - 多公式识别依赖图像分割质量
   - 表达式计算采用简化算法(左到右计算,不考虑运算符优先级)

### 改进建议

为了获得更好的公式识别效果,建议:

1. **使用深度学习模型**
   - 训练CNN进行字符识别
   - 使用LSTM/Transformer进行序列识别
   - 参考: CRNN, Attention-based OCR模型

2. **集成专业OCR引擎**
   - 使用Tesseract C++ API
   - 或使用OpenCV DNN模块加载预训练模型
   - 参考: EAST文本检测 + CRNN识别

3. **改进特征提取**
   - 使用HOG、SIFT等高级特征
   - 增加模板匹配库
   - 实现字符级别的深度特征学习

## 输出示例

```
========================================
  公式识别系统 v1.0 (C++ CLI版本)
========================================

图像尺寸: 400 x 100

开始图像预处理...
正在检测字符...
检测到 8 个字符
识别的字符序列: 12+34=46

========================================
           识别结果
========================================
识别的表达式: 12+34=46
计算结果: 12+34 = 46
预期结果: 46
✓ 结果正确!
========================================
```

注意: 由于采用基于规则的识别方法,识别精度受图像质量和字体影响较大。

## 项目文件结构

```
.
├── conveyor_inspection_cli.cpp        # 任务1: 流水线产品检测
├── formula_recognition.cpp            # 任务2: 公式识别
├── CMakeLists.txt                     # CMake配置
├── formula_images/                    # 测试图片目录
│   ├── formula_1.png ... formula_6.png
├── video/                             # 任务1测试视频
│   ├── 1.mp4
│   └── 2.mp4
├── build/                             # 编译输出目录
│   ├── conveyor_inspection_cli        # 任务1可执行文件
│   └── formula_recognition_cli        # 任务2可执行文件
└── README.md                          # 本文件
```

---

## 许可证

本项目仅用于教学和学习目的。
