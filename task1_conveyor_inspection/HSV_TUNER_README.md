# HSV 颜色检测参数调节工具使用说明

## 🎯 功能介绍

这是一个可视化的HSV参数调节工具，可以实时预览不同参数对检测效果的影响。

## 🚀 使用方法

### 启动工具

```bash
cd build
./hsv_tuner ../video/2.mp4
```

### 界面说明

工具会打开5个窗口：

1. **Original** - 原始视频帧
2. **Mask** - HSV颜色检测掩码（未经形态学处理）
3. **Processed Mask** - 经过形态学处理后的掩码
4. **Result** - 最终检测结果
   - 🟢 绿色轮廓 = 合格品（矩形）
   - 🔴 红色轮廓 = 次品（其他形状）
   - 显示每个产品的顶点数(V)、面积(A)、填充度(F)
5. **Controls** - 参数控制面板（滑动条）

### 📊 可调节参数

#### HSV颜色范围
- **H Min/Max** - 色调范围 (0-179)
  - 绿色通常在 35-85 范围
- **S Min/Max** - 饱和度范围 (0-255)
  - 提高S Min可以过滤低饱和度噪点
- **V Min/Max** - 明度范围 (0-255)
  - 提高V Min可以过滤暗色噪点

#### 形态学操作
- **Kernel Size** - 核大小 (1-15)
  - 越大去噪效果越强，但可能损失细节
- **Open Iterations** - 开运算迭代次数 (0-5)
  - 去除小噪点
- **Close Iterations** - 闭运算迭代次数 (0-5)
  - 填充产品内部空洞

#### 过滤条件
- **Area Threshold/100** - 面积阈值 (0-500)
  - 实际面积 = 滑动条值 × 100
  - 过滤小于此面积的轮廓
- **Fill Ratio %** - 填充度阈值 (0-100)
  - 矩形判断条件：4顶点 && 填充度 > 此值%

### ⌨️ 键盘操作

- **SPACE** - 切换到下一帧
- **r** - 重置到第一帧
- **p** - 打印当前参数（包括可以直接复制的代码）
- **q** 或 **ESC** - 退出程序

## 📝 调节建议

### 减少误检测（多检测了产品）

1. **提高HSV下限**
   - 增加 `S Min` 和 `V Min` 过滤暗色/低饱和度噪点

2. **增强形态学去噪**
   - 增加 `Open Iterations` 或 `Kernel Size`

3. **提高面积阈值**
   - 增加 `Area Threshold/100`

4. **提高填充度要求**
   - 增加 `Fill Ratio %`

### 避免漏检测（少检测了产品）

1. **放宽HSV范围**
   - 降低 `S Min` 和 `V Min`

2. **减弱形态学操作**
   - 减少 `Open Iterations`

3. **降低面积阈值**
   - 减少 `Area Threshold/100`

## 🎨 调节流程建议

### 步骤1：调节HSV范围
1. 观察 **Mask** 窗口
2. 确保所有产品都被检测到（白色）
3. 尽量减少背景噪点（黑色）

### 步骤2：调节形态学参数
1. 观察 **Processed Mask** 窗口
2. 使用开运算去除小噪点
3. 使用闭运算填充产品内部空洞

### 步骤3：调节过滤条件
1. 观察 **Result** 窗口
2. 调节面积阈值过滤小轮廓
3. 调节填充度阈值区分矩形和其他形状

### 步骤4：验证多帧
1. 按 **SPACE** 切换到不同帧
2. 确保参数在所有帧都有效
3. 特别注意产品进入/离开的帧

### 步骤5：导出参数
1. 按 **p** 打印参数
2. 复制代码到 `conveyor_inspector.cpp`

## 🔧 示例参数

### 当前默认参数
```cpp
// HSV范围
Scalar lower_green(35, 40, 40);
Scalar upper_green(85, 255, 255);

// 形态学
Mat kernel = getStructuringElement(MORPH_RECT, Size(5, 5));
morphologyEx(mask, mask, MORPH_OPEN, kernel, Point(-1,-1), 2);
morphologyEx(mask, mask, MORPH_CLOSE, kernel, Point(-1,-1), 1);

// 过滤
if (area < 5000) continue;
if (approx.size() == 4 && area_ratio > 0.72)
```

## 💡 调试技巧

1. **先处理背景简单的视频**
   - 在视频1上调好基础参数
   - 再在视频2上微调

2. **关注统计信息**
   - Result窗口顶部显示实时计数
   - 对比期望的数量

3. **逐帧检查**
   - 使用SPACE逐帧播放
   - 找出误检测/漏检测的帧
   - 针对性调整参数

4. **记录参数**
   - 对不同视频使用不同参数组
   - 按p打印参数并保存

## 🎯 目标

- **视频1**: 3合格品 + 3次品 = 6个
- **视频2**: 1合格品 + 7次品 = 8个

祝调参顺利！🎉
