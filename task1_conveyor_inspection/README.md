# 流水线产品质量检测系统

基于OpenCV的实时视频产品检测与质量分类系统。

## 任务完成清单

### 📋 基本任务

- [x] 能够正确读取并播放提供的模拟视频文件
- [x] 当视频播放结束后，程序应在控制台或弹出窗口中，清晰打印出最终的统计报告（次品数量和合格品数量）
- [x] 搭建环境基础：配置并能正确使用OpenCV，可以正常播放视频且能进行基本操作
- [x] 输出合格品数量：视频1准确识别3个，视频2准确识别1个
- [x] 输出次品数量：视频1准确识别3个，视频2准确识别7个

### 🌟 拓展任务

- [x] 工件有旋转和小幅度高度差（体现在图像中为缩放）依然能够识别
- [x] 工件发生旋转或缩放时能给出旋转角度和缩放倍数
- [x] 能实时输出已经经过传送带的合格/次品数量
- [x] 尽可能加快识别速度（实现了约30fps的实时处理）
- [x] 输出合格率

### 💡 额外创新功能

- [x] 通用白色背景检测：不依赖产品颜色
- [x] 智能填充度分类：基于填充度判断形状
- [x] 多方向追踪系统：支持左→右、右→左、上→下、下→上四个方向
- [x] Qt实时可视化窗口：
  - [x] 绿色框标注合格品
  - [x] 红色框标注次品
  - [x] 实时显示旋转角度和缩放倍数
  - [x] 顶部统计栏显示当前计数
- [x] HSV参数调节工具（GUI和命令行版本）

## 功能特点

- ✅ **白色背景检测**：通用检测方法，不依赖产品颜色
- ✅ **形状分类**：基于填充度自动识别矩形（合格品）与其他形状（次品）
- ✅ **旋转和缩放识别**：自动检测并输出旋转角度（0-360°）和缩放倍数
- ✅ **多方向追踪**：支持产品从左右、上下四个方向移动
- ✅ **实时可视化**：Qt + Wayland 实时显示窗口，30fps流畅播放
- ✅ **准确计数**：精确统计合格品和次品数量，零误差
- ✅ **合格率计算**：自动计算并显示产品合格率

## 系统要求

- **OpenCV 4.x** (编译时需启用 Qt 支持)
- **C++11** 或更高版本
- **CMake 3.10+**
- **Qt5** 开发库
- **Wayland** (WSL2 环境)

## 编译

### 首次编译 OpenCV（使用 Qt 后端）

如果你的 OpenCV 使用 GTK 后端（WSL 中不支持），需要重新编译：

```bash
cd /home/serenNan/Tools/opencv/build
cmake -D WITH_QT=ON \
      -D WITH_GTK=OFF \
      -D CMAKE_BUILD_TYPE=RELEASE \
      -D CMAKE_INSTALL_PREFIX=/usr/local \
      ..
make -j$(nproc)
sudo make install
sudo ldconfig
```

### 编译项目

```bash
mkdir build && cd build
cmake ..
make
```

## 使用方法

```bash
# 设置环境变量
export QT_QPA_PLATFORM=wayland
export WAYLAND_DISPLAY=wayland-0

cd build

# 实时显示（默认）
./conveyor_inspection_cli ../video/1.mp4
./conveyor_inspection_cli ../video/2.mp4
```

## 输出说明

### 实时显示窗口

程序默认会打开一个 **Qt 窗口**实时显示检测过程：

- **绿色框**：合格品（矩形，填充度 > 0.78）
- **红色框**：次品（其他形状，填充度 < 0.78）
- **青色竖线**：计数线（左侧20%，右侧80%）
- **产品标签**（实时显示在每个工件上方，三行文字）：
  - 第1行：`ID:X OK/NG` - 追踪ID和类型（OK=合格品，NG=次品）
  - 第2行：`Angle:XX.Xdeg` - 旋转角度（相对于正置，单位：度）
  - 第3行：`Scale:X.XXx` - 缩放倍数（相对于基准）
- **顶部信息栏**（黑色背景，70px高）：
  - **第1行（白色大字）**：
    - Frame: 当前帧号
    - Qualified: 已计数的合格品数量
    - Defective: 已计数的次品数量
    - Total: 总计数量
  - **第2行（黄色小字）**：
    - Scale Reference: 缩放基准尺寸（如：143.0px (1st Qualified)）
    - 未初始化时显示橙色提示："Waiting for first qualified product..."

### 命令行输出

实时打印每帧的检测信息：
```
[Frame 51] vertices=4, area=6575, fill=0.98, type=qualified
[Frame 51] vertices=3, area=19102, fill=0.54, type=defective
Frame 99: ✓ QUALIFIED ← - ID:1, Angle: 90.0°, Scale: 1.34x | Total -> Qualified: 1, Defective: 1
```

最终统计报告：
```
============================================================
最终统计报告
============================================================
视频: ../video/1.mp4
------------------------------------------------------------
合格品数量: 3
次品数量:   3
总计:       6
合格率:     50.00%
缩放基准:   143.0px (首个合格品)
============================================================

详细产品列表（按ID排序）:
============================================================
ID    类型      旋转角度   缩放倍数   检测帧
------------------------------------------------------------
0     ✗ 次品  90.0°         1.52x          82
1     ✓ 合格品180.0°        1.87x          99
2     ✓ 合格品180.0°        1.81x          173
3     ✓ 合格品180.0°        1.81x          190
4     ✗ 次品  90.0°         1.48x          262
5     ✗ 次品  90.0°         1.49x          280
============================================================
```

### 窗口控制

- **ESC** 或 **q** - 退出播放
- 窗口可调整大小
- 实时更新，约30fps

## 检测原理

### 1. 白色背景检测

```cpp
// 检测白色背景（HSV空间）
Scalar lower_white(0, 0, 200);     // H不限，S低，V高
Scalar upper_white(179, 30, 255);
inRange(hsv, lower_white, upper_white, mask);

// 反转掩码：背景→黑，产品→白
bitwise_not(mask, mask);
```

### 2. 形状分类

基于**填充度**判断产品类型：

```cpp
float fill_ratio = contour_area / bounding_rect_area;

if (fill_ratio > 0.78) {
    // 矩形（合格品）：填充度 > 0.78
} else {
    // 其他形状（次品）：填充度 < 0.78
}
```

### 3. 旋转角度计算（符合评分规则）

**矩形（合格品）正置角度定义**：
- 正置 = 长边水平且在下方时为 0°
- 计算相对于正置的旋转角度
- 输出角度范围：[0, 360)

**其他形状（次品）**：
- 在同一视频内保持相对角度正确即可

### 4. 缩放倍数计算（符合评分规则）

**统一缩放基准**：
- 使用视频中首个检测到的合格品长边尺寸作为 1.0x 基准
- 所有工件缩放倍数 = 当前长边 / 基准长边
- 程序自动输出基准设置信息

### 5. 多方向追踪

- 记录产品初始位置
- 计算移动方向（dx, dy）
- 根据方向设置不同计数线：
  - 左→右：右侧计数线（80%）
  - 右→左：左侧计数线（20%）
  - 上→下 / 下→上：垂直计数线

## 检测结果

### 视频 1

- **合格品**：3 个 ✅
- **次品**：3 个 ✅
- **总计**：6 个
- **合格率**：50.00%
- **准确度**：100%（零误差）

### 视频 2

- **合格品**：1 个 ✅
- **次品**：7 个 ✅
- **总计**：8 个
- **合格率**：12.50%
- **准确度**：100%（零误差）

### 特殊检测功能

#### 旋转识别（符合评分规则）

**正置角度定义（根据官方要求）**：
- ✅ **矩形（合格品）**：长边水平且在下方时为 **0°** 正置
- ✅ **其他图形（次品）**：在同一视频内保持相对角度正确即可

**输出的角度含义**：
- 输出角度 = 当前角度 - 正置角度
- 矩形示例：
  - `Angle: 0.0°` - 长边水平（正置）
  - `Angle: 90.0°` - 旋转90°（短边水平）
  - `Angle: 180.0°` - 旋转180°（倒置）
- 次品示例：`Angle: 45.2°`, `Angle: 90.0°`

#### 缩放识别（符合评分规则）

**统一缩放基准（根据官方要求）**：
- ✅ 使用视频中**首个检测到的合格品**的长边尺寸作为 **1.0x** 基准
- ✅ 所有后续工件的缩放倍数相对于该基准计算
- ✅ 程序启动时自动输出基准尺寸信息

**示例输出**：
```
[缩放基准已设置] 使用首个合格品长边尺寸: 143.00px
Scale: 1.00x  - 与基准尺寸相同
Scale: 1.87x  - 比基准大87%
Scale: 0.87x  - 比基准小13%
```

#### 实时输出示例
```bash
[缩放基准已设置] 使用首个合格品长边尺寸: 143.00px
[Frame 51] vertices=4, area=6575, fill=0.98, type=qualified
[Frame 51] vertices=3, area=19102, fill=0.54, type=defective
Frame 99: ✓ QUALIFIED ← - ID:1, Angle: 180.0°, Scale: 1.87x | Total -> Qualified: 1, Defective: 1
Frame 262: ✗ DEFECTIVE ← - ID:4, Angle: 90.0°, Scale: 1.48x | Total -> Qualified: 3, Defective: 2
```

## 参数调节工具

如需调整检测参数，可使用HSV调节工具。详见 [HSV_TUNER_README.md](HSV_TUNER_README.md)

## 技术栈

- **OpenCV 4.8.0**
- **C++11**
- **CMake 3.10+**

## 项目结构

```
.
├── main.cpp                    # 程序入口
├── conveyor_inspector.h        # 检测器头文件
├── conveyor_inspector.cpp      # 核心检测逻辑
├── hsv_tuner.cpp              # GUI参数调节工具
├── hsv_tuner_headless.cpp     # 无GUI参数调节工具
├── HSV_TUNER_README.md        # 调节工具说明文档
├── CMakeLists.txt             # 编译配置
├── video/                     # 测试视频
│   ├── 1.mp4
│   └── 2.mp4
└── build/                     # 编译输出
    ├── conveyor_inspection_cli  # 主程序可执行文件
    ├── hsv_tuner                # GUI调节工具
    └── hsv_tuner_headless       # 无GUI调节工具
```

## 故障排除

### Q: 窗口无法显示，报错 "Can't initialize GTK backend"

**A:** OpenCV 使用了 GTK 后端，需要重新编译使用 Qt：
```bash
cd /home/serenNan/Tools/opencv/build
cmake -D WITH_QT=ON -D WITH_GTK=OFF ..
make -j$(nproc) && sudo make install
```
