# æµæ°´çº¿äº§å“è´¨é‡æ£€æµ‹ç³»ç»Ÿ

åŸºäºOpenCVçš„å®æ—¶è§†é¢‘äº§å“æ£€æµ‹ä¸è´¨é‡åˆ†ç±»ç³»ç»Ÿã€‚

## ä»»åŠ¡å®Œæˆæ¸…å•

### ğŸ“‹ åŸºæœ¬ä»»åŠ¡

- [x] èƒ½å¤Ÿæ­£ç¡®è¯»å–å¹¶æ’­æ”¾æä¾›çš„æ¨¡æ‹Ÿè§†é¢‘æ–‡ä»¶
- [x] å½“è§†é¢‘æ’­æ”¾ç»“æŸåï¼Œç¨‹åºåº”åœ¨æ§åˆ¶å°æˆ–å¼¹å‡ºçª—å£ä¸­ï¼Œæ¸…æ™°æ‰“å°å‡ºæœ€ç»ˆçš„ç»Ÿè®¡æŠ¥å‘Šï¼ˆæ¬¡å“æ•°é‡å’Œåˆæ ¼å“æ•°é‡ï¼‰
- [x] æ­å»ºç¯å¢ƒåŸºç¡€ï¼šé…ç½®å¹¶èƒ½æ­£ç¡®ä½¿ç”¨OpenCVï¼Œå¯ä»¥æ­£å¸¸æ’­æ”¾è§†é¢‘ä¸”èƒ½è¿›è¡ŒåŸºæœ¬æ“ä½œ
- [x] è¾“å‡ºåˆæ ¼å“æ•°é‡ï¼šè§†é¢‘1å‡†ç¡®è¯†åˆ«3ä¸ªï¼Œè§†é¢‘2å‡†ç¡®è¯†åˆ«1ä¸ª
- [x] è¾“å‡ºæ¬¡å“æ•°é‡ï¼šè§†é¢‘1å‡†ç¡®è¯†åˆ«3ä¸ªï¼Œè§†é¢‘2å‡†ç¡®è¯†åˆ«7ä¸ª

### ğŸŒŸ æ‹“å±•ä»»åŠ¡

- [x] å·¥ä»¶æœ‰æ—‹è½¬å’Œå°å¹…åº¦é«˜åº¦å·®ï¼ˆä½“ç°åœ¨å›¾åƒä¸­ä¸ºç¼©æ”¾ï¼‰ä¾ç„¶èƒ½å¤Ÿè¯†åˆ«
- [x] å·¥ä»¶å‘ç”Ÿæ—‹è½¬æˆ–ç¼©æ”¾æ—¶èƒ½ç»™å‡ºæ—‹è½¬è§’åº¦å’Œç¼©æ”¾å€æ•°
- [x] èƒ½å®æ—¶è¾“å‡ºå·²ç»ç»è¿‡ä¼ é€å¸¦çš„åˆæ ¼/æ¬¡å“æ•°é‡
- [x] å°½å¯èƒ½åŠ å¿«è¯†åˆ«é€Ÿåº¦ï¼ˆå®ç°äº†çº¦30fpsçš„å®æ—¶å¤„ç†ï¼‰
- [x] è¾“å‡ºåˆæ ¼ç‡

### ğŸ’¡ é¢å¤–åˆ›æ–°åŠŸèƒ½

- [x] é€šç”¨ç™½è‰²èƒŒæ™¯æ£€æµ‹ï¼šä¸ä¾èµ–äº§å“é¢œè‰²
- [x] æ™ºèƒ½å¡«å……åº¦åˆ†ç±»ï¼šåŸºäºå¡«å……åº¦åˆ¤æ–­å½¢çŠ¶
- [x] å¤šæ–¹å‘è¿½è¸ªç³»ç»Ÿï¼šæ”¯æŒå·¦â†’å³ã€å³â†’å·¦ã€ä¸Šâ†’ä¸‹ã€ä¸‹â†’ä¸Šå››ä¸ªæ–¹å‘
- [x] Qtå®æ—¶å¯è§†åŒ–çª—å£ï¼š
  - [x] ç»¿è‰²æ¡†æ ‡æ³¨åˆæ ¼å“
  - [x] çº¢è‰²æ¡†æ ‡æ³¨æ¬¡å“
  - [x] å®æ—¶æ˜¾ç¤ºæ—‹è½¬è§’åº¦å’Œç¼©æ”¾å€æ•°
  - [x] é¡¶éƒ¨ç»Ÿè®¡æ æ˜¾ç¤ºå½“å‰è®¡æ•°
- [x] HSVå‚æ•°è°ƒèŠ‚å·¥å…·ï¼ˆGUIå’Œå‘½ä»¤è¡Œç‰ˆæœ¬ï¼‰

## åŠŸèƒ½ç‰¹ç‚¹

- âœ… **ç™½è‰²èƒŒæ™¯æ£€æµ‹**ï¼šé€šç”¨æ£€æµ‹æ–¹æ³•ï¼Œä¸ä¾èµ–äº§å“é¢œè‰²
- âœ… **å½¢çŠ¶åˆ†ç±»**ï¼šåŸºäºå¡«å……åº¦è‡ªåŠ¨è¯†åˆ«çŸ©å½¢ï¼ˆåˆæ ¼å“ï¼‰ä¸å…¶ä»–å½¢çŠ¶ï¼ˆæ¬¡å“ï¼‰
- âœ… **æ—‹è½¬å’Œç¼©æ”¾è¯†åˆ«**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶è¾“å‡ºæ—‹è½¬è§’åº¦ï¼ˆ0-360Â°ï¼‰å’Œç¼©æ”¾å€æ•°
- âœ… **å¤šæ–¹å‘è¿½è¸ª**ï¼šæ”¯æŒäº§å“ä»å·¦å³ã€ä¸Šä¸‹å››ä¸ªæ–¹å‘ç§»åŠ¨
- âœ… **å®æ—¶å¯è§†åŒ–**ï¼šQt + Wayland å®æ—¶æ˜¾ç¤ºçª—å£ï¼Œ30fpsæµç•…æ’­æ”¾
- âœ… **å‡†ç¡®è®¡æ•°**ï¼šç²¾ç¡®ç»Ÿè®¡åˆæ ¼å“å’Œæ¬¡å“æ•°é‡ï¼Œé›¶è¯¯å·®
- âœ… **åˆæ ¼ç‡è®¡ç®—**ï¼šè‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤ºäº§å“åˆæ ¼ç‡

## ç³»ç»Ÿè¦æ±‚

- **OpenCV 4.x** (ç¼–è¯‘æ—¶éœ€å¯ç”¨ Qt æ”¯æŒ)
- **C++11** æˆ–æ›´é«˜ç‰ˆæœ¬
- **CMake 3.10+**
- **Qt5** å¼€å‘åº“
- **Wayland** (WSL2 ç¯å¢ƒ)

## ç¼–è¯‘

### é¦–æ¬¡ç¼–è¯‘ OpenCVï¼ˆä½¿ç”¨ Qt åç«¯ï¼‰

å¦‚æœä½ çš„ OpenCV ä½¿ç”¨ GTK åç«¯ï¼ˆWSL ä¸­ä¸æ”¯æŒï¼‰ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ï¼š

```bash
cd /home/serenNan/Tools/opencv/build
cmake -D WITH_QT=ON \
      -D WITH_GTK=OFF \
      -D CMAKE_BUILD_TYPE=RELEASE \
      -D CMAKE_INSTALL_PREFIX=/usr/local \
      ..
make -j$(nproc)
sudo make install
sudo ldconfig
```

### ç¼–è¯‘é¡¹ç›®

```bash
mkdir build && cd build
cmake ..
make
```

## ä½¿ç”¨æ–¹æ³•

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export QT_QPA_PLATFORM=wayland
export WAYLAND_DISPLAY=wayland-0

cd build

# å®æ—¶æ˜¾ç¤ºï¼ˆé»˜è®¤ï¼‰
./conveyor_inspection_cli ../video/1.mp4
./conveyor_inspection_cli ../video/2.mp4
```

## è¾“å‡ºè¯´æ˜

### å®æ—¶æ˜¾ç¤ºçª—å£

ç¨‹åºé»˜è®¤ä¼šæ‰“å¼€ä¸€ä¸ª **Qt çª—å£**å®æ—¶æ˜¾ç¤ºæ£€æµ‹è¿‡ç¨‹ï¼š

- **ç»¿è‰²æ¡†**ï¼šåˆæ ¼å“ï¼ˆçŸ©å½¢ï¼Œå¡«å……åº¦ > 0.78ï¼‰
- **çº¢è‰²æ¡†**ï¼šæ¬¡å“ï¼ˆå…¶ä»–å½¢çŠ¶ï¼Œå¡«å……åº¦ < 0.78ï¼‰
- **é’è‰²ç«–çº¿**ï¼šè®¡æ•°çº¿ï¼ˆå·¦ä¾§20%ï¼Œå³ä¾§80%ï¼‰
- **äº§å“æ ‡ç­¾**ï¼ˆå®æ—¶æ˜¾ç¤ºåœ¨æ¯ä¸ªå·¥ä»¶ä¸Šæ–¹ï¼Œä¸‰è¡Œæ–‡å­—ï¼‰ï¼š
  - ç¬¬1è¡Œï¼š`ID:X OK/NG` - è¿½è¸ªIDå’Œç±»å‹ï¼ˆOK=åˆæ ¼å“ï¼ŒNG=æ¬¡å“ï¼‰
  - ç¬¬2è¡Œï¼š`Angle:XX.Xdeg` - æ—‹è½¬è§’åº¦ï¼ˆç›¸å¯¹äºæ­£ç½®ï¼Œå•ä½ï¼šåº¦ï¼‰
  - ç¬¬3è¡Œï¼š`Scale:X.XXx` - ç¼©æ”¾å€æ•°ï¼ˆç›¸å¯¹äºåŸºå‡†ï¼‰
- **é¡¶éƒ¨ä¿¡æ¯æ **ï¼ˆé»‘è‰²èƒŒæ™¯ï¼Œ70pxé«˜ï¼‰ï¼š
  - **ç¬¬1è¡Œï¼ˆç™½è‰²å¤§å­—ï¼‰**ï¼š
    - Frame: å½“å‰å¸§å·
    - Qualified: å·²è®¡æ•°çš„åˆæ ¼å“æ•°é‡
    - Defective: å·²è®¡æ•°çš„æ¬¡å“æ•°é‡
    - Total: æ€»è®¡æ•°é‡
  - **ç¬¬2è¡Œï¼ˆé»„è‰²å°å­—ï¼‰**ï¼š
    - Scale Reference: ç¼©æ”¾åŸºå‡†å°ºå¯¸ï¼ˆå¦‚ï¼š143.0px (1st Qualified)ï¼‰
    - æœªåˆå§‹åŒ–æ—¶æ˜¾ç¤ºæ©™è‰²æç¤ºï¼š"Waiting for first qualified product..."

### å‘½ä»¤è¡Œè¾“å‡º

å®æ—¶æ‰“å°æ¯å¸§çš„æ£€æµ‹ä¿¡æ¯ï¼š
```
[Frame 51] vertices=4, area=6575, fill=0.98, type=qualified
[Frame 51] vertices=3, area=19102, fill=0.54, type=defective
Frame 99: âœ“ QUALIFIED â† - ID:1, Angle: 90.0Â°, Scale: 1.34x | Total -> Qualified: 1, Defective: 1
```

æœ€ç»ˆç»Ÿè®¡æŠ¥å‘Šï¼š
```
============================================================
æœ€ç»ˆç»Ÿè®¡æŠ¥å‘Š
============================================================
è§†é¢‘: ../video/1.mp4
------------------------------------------------------------
åˆæ ¼å“æ•°é‡: 3
æ¬¡å“æ•°é‡:   3
æ€»è®¡:       6
åˆæ ¼ç‡:     50.00%
ç¼©æ”¾åŸºå‡†:   143.0px (é¦–ä¸ªåˆæ ¼å“)
============================================================

è¯¦ç»†äº§å“åˆ—è¡¨ï¼ˆæŒ‰IDæ’åºï¼‰:
============================================================
ID    ç±»å‹      æ—‹è½¬è§’åº¦   ç¼©æ”¾å€æ•°   æ£€æµ‹å¸§
------------------------------------------------------------
0     âœ— æ¬¡å“  90.0Â°         1.52x          82
1     âœ“ åˆæ ¼å“180.0Â°        1.87x          99
2     âœ“ åˆæ ¼å“180.0Â°        1.81x          173
3     âœ“ åˆæ ¼å“180.0Â°        1.81x          190
4     âœ— æ¬¡å“  90.0Â°         1.48x          262
5     âœ— æ¬¡å“  90.0Â°         1.49x          280
============================================================
```

### çª—å£æ§åˆ¶

- **ESC** æˆ– **q** - é€€å‡ºæ’­æ”¾
- çª—å£å¯è°ƒæ•´å¤§å°
- å®æ—¶æ›´æ–°ï¼Œçº¦30fps

## æ£€æµ‹åŸç†

### 1. ç™½è‰²èƒŒæ™¯æ£€æµ‹

```cpp
// æ£€æµ‹ç™½è‰²èƒŒæ™¯ï¼ˆHSVç©ºé—´ï¼‰
Scalar lower_white(0, 0, 200);     // Hä¸é™ï¼ŒSä½ï¼ŒVé«˜
Scalar upper_white(179, 30, 255);
inRange(hsv, lower_white, upper_white, mask);

// åè½¬æ©ç ï¼šèƒŒæ™¯â†’é»‘ï¼Œäº§å“â†’ç™½
bitwise_not(mask, mask);
```

### 2. å½¢çŠ¶åˆ†ç±»

åŸºäº**å¡«å……åº¦**åˆ¤æ–­äº§å“ç±»å‹ï¼š

```cpp
float fill_ratio = contour_area / bounding_rect_area;

if (fill_ratio > 0.78) {
    // çŸ©å½¢ï¼ˆåˆæ ¼å“ï¼‰ï¼šå¡«å……åº¦ > 0.78
} else {
    // å…¶ä»–å½¢çŠ¶ï¼ˆæ¬¡å“ï¼‰ï¼šå¡«å……åº¦ < 0.78
}
```

### 3. æ—‹è½¬è§’åº¦è®¡ç®—ï¼ˆç¬¦åˆè¯„åˆ†è§„åˆ™ï¼‰

**çŸ©å½¢ï¼ˆåˆæ ¼å“ï¼‰æ­£ç½®è§’åº¦å®šä¹‰**ï¼š
- æ­£ç½® = é•¿è¾¹æ°´å¹³ä¸”åœ¨ä¸‹æ–¹æ—¶ä¸º 0Â°
- è®¡ç®—ç›¸å¯¹äºæ­£ç½®çš„æ—‹è½¬è§’åº¦
- è¾“å‡ºè§’åº¦èŒƒå›´ï¼š[0, 360)

**å…¶ä»–å½¢çŠ¶ï¼ˆæ¬¡å“ï¼‰**ï¼š
- åœ¨åŒä¸€è§†é¢‘å†…ä¿æŒç›¸å¯¹è§’åº¦æ­£ç¡®å³å¯

### 4. ç¼©æ”¾å€æ•°è®¡ç®—ï¼ˆç¬¦åˆè¯„åˆ†è§„åˆ™ï¼‰

**ç»Ÿä¸€ç¼©æ”¾åŸºå‡†**ï¼š
- ä½¿ç”¨è§†é¢‘ä¸­é¦–ä¸ªæ£€æµ‹åˆ°çš„åˆæ ¼å“é•¿è¾¹å°ºå¯¸ä½œä¸º 1.0x åŸºå‡†
- æ‰€æœ‰å·¥ä»¶ç¼©æ”¾å€æ•° = å½“å‰é•¿è¾¹ / åŸºå‡†é•¿è¾¹
- ç¨‹åºè‡ªåŠ¨è¾“å‡ºåŸºå‡†è®¾ç½®ä¿¡æ¯

### 5. å¤šæ–¹å‘è¿½è¸ª

- è®°å½•äº§å“åˆå§‹ä½ç½®
- è®¡ç®—ç§»åŠ¨æ–¹å‘ï¼ˆdx, dyï¼‰
- æ ¹æ®æ–¹å‘è®¾ç½®ä¸åŒè®¡æ•°çº¿ï¼š
  - å·¦â†’å³ï¼šå³ä¾§è®¡æ•°çº¿ï¼ˆ80%ï¼‰
  - å³â†’å·¦ï¼šå·¦ä¾§è®¡æ•°çº¿ï¼ˆ20%ï¼‰
  - ä¸Šâ†’ä¸‹ / ä¸‹â†’ä¸Šï¼šå‚ç›´è®¡æ•°çº¿

## æ£€æµ‹ç»“æœ

### è§†é¢‘ 1

- **åˆæ ¼å“**ï¼š3 ä¸ª âœ…
- **æ¬¡å“**ï¼š3 ä¸ª âœ…
- **æ€»è®¡**ï¼š6 ä¸ª
- **åˆæ ¼ç‡**ï¼š50.00%
- **å‡†ç¡®åº¦**ï¼š100%ï¼ˆé›¶è¯¯å·®ï¼‰

### è§†é¢‘ 2

- **åˆæ ¼å“**ï¼š1 ä¸ª âœ…
- **æ¬¡å“**ï¼š7 ä¸ª âœ…
- **æ€»è®¡**ï¼š8 ä¸ª
- **åˆæ ¼ç‡**ï¼š12.50%
- **å‡†ç¡®åº¦**ï¼š100%ï¼ˆé›¶è¯¯å·®ï¼‰

### ç‰¹æ®Šæ£€æµ‹åŠŸèƒ½

#### æ—‹è½¬è¯†åˆ«ï¼ˆç¬¦åˆè¯„åˆ†è§„åˆ™ï¼‰

**æ­£ç½®è§’åº¦å®šä¹‰ï¼ˆæ ¹æ®å®˜æ–¹è¦æ±‚ï¼‰**ï¼š
- âœ… **çŸ©å½¢ï¼ˆåˆæ ¼å“ï¼‰**ï¼šé•¿è¾¹æ°´å¹³ä¸”åœ¨ä¸‹æ–¹æ—¶ä¸º **0Â°** æ­£ç½®
- âœ… **å…¶ä»–å›¾å½¢ï¼ˆæ¬¡å“ï¼‰**ï¼šåœ¨åŒä¸€è§†é¢‘å†…ä¿æŒç›¸å¯¹è§’åº¦æ­£ç¡®å³å¯

**è¾“å‡ºçš„è§’åº¦å«ä¹‰**ï¼š
- è¾“å‡ºè§’åº¦ = å½“å‰è§’åº¦ - æ­£ç½®è§’åº¦
- çŸ©å½¢ç¤ºä¾‹ï¼š
  - `Angle: 0.0Â°` - é•¿è¾¹æ°´å¹³ï¼ˆæ­£ç½®ï¼‰
  - `Angle: 90.0Â°` - æ—‹è½¬90Â°ï¼ˆçŸ­è¾¹æ°´å¹³ï¼‰
  - `Angle: 180.0Â°` - æ—‹è½¬180Â°ï¼ˆå€’ç½®ï¼‰
- æ¬¡å“ç¤ºä¾‹ï¼š`Angle: 45.2Â°`, `Angle: 90.0Â°`

#### ç¼©æ”¾è¯†åˆ«ï¼ˆç¬¦åˆè¯„åˆ†è§„åˆ™ï¼‰

**ç»Ÿä¸€ç¼©æ”¾åŸºå‡†ï¼ˆæ ¹æ®å®˜æ–¹è¦æ±‚ï¼‰**ï¼š
- âœ… ä½¿ç”¨è§†é¢‘ä¸­**é¦–ä¸ªæ£€æµ‹åˆ°çš„åˆæ ¼å“**çš„é•¿è¾¹å°ºå¯¸ä½œä¸º **1.0x** åŸºå‡†
- âœ… æ‰€æœ‰åç»­å·¥ä»¶çš„ç¼©æ”¾å€æ•°ç›¸å¯¹äºè¯¥åŸºå‡†è®¡ç®—
- âœ… ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨è¾“å‡ºåŸºå‡†å°ºå¯¸ä¿¡æ¯

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
[ç¼©æ”¾åŸºå‡†å·²è®¾ç½®] ä½¿ç”¨é¦–ä¸ªåˆæ ¼å“é•¿è¾¹å°ºå¯¸: 143.00px
Scale: 1.00x  - ä¸åŸºå‡†å°ºå¯¸ç›¸åŒ
Scale: 1.87x  - æ¯”åŸºå‡†å¤§87%
Scale: 0.87x  - æ¯”åŸºå‡†å°13%
```

#### å®æ—¶è¾“å‡ºç¤ºä¾‹
```bash
[ç¼©æ”¾åŸºå‡†å·²è®¾ç½®] ä½¿ç”¨é¦–ä¸ªåˆæ ¼å“é•¿è¾¹å°ºå¯¸: 143.00px
[Frame 51] vertices=4, area=6575, fill=0.98, type=qualified
[Frame 51] vertices=3, area=19102, fill=0.54, type=defective
Frame 99: âœ“ QUALIFIED â† - ID:1, Angle: 180.0Â°, Scale: 1.87x | Total -> Qualified: 1, Defective: 1
Frame 262: âœ— DEFECTIVE â† - ID:4, Angle: 90.0Â°, Scale: 1.48x | Total -> Qualified: 3, Defective: 2
```

## å‚æ•°è°ƒèŠ‚å·¥å…·

å¦‚éœ€è°ƒæ•´æ£€æµ‹å‚æ•°ï¼Œå¯ä½¿ç”¨HSVè°ƒèŠ‚å·¥å…·ã€‚è¯¦è§ [HSV_TUNER_README.md](HSV_TUNER_README.md)

## æŠ€æœ¯æ ˆ

- **OpenCV 4.8.0**
- **C++11**
- **CMake 3.10+**

## é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ main.cpp                    # ç¨‹åºå…¥å£
â”œâ”€â”€ conveyor_inspector.h        # æ£€æµ‹å™¨å¤´æ–‡ä»¶
â”œâ”€â”€ conveyor_inspector.cpp      # æ ¸å¿ƒæ£€æµ‹é€»è¾‘
â”œâ”€â”€ hsv_tuner.cpp              # GUIå‚æ•°è°ƒèŠ‚å·¥å…·
â”œâ”€â”€ hsv_tuner_headless.cpp     # æ— GUIå‚æ•°è°ƒèŠ‚å·¥å…·
â”œâ”€â”€ HSV_TUNER_README.md        # è°ƒèŠ‚å·¥å…·è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ CMakeLists.txt             # ç¼–è¯‘é…ç½®
â”œâ”€â”€ video/                     # æµ‹è¯•è§†é¢‘
â”‚   â”œâ”€â”€ 1.mp4
â”‚   â””â”€â”€ 2.mp4
â””â”€â”€ build/                     # ç¼–è¯‘è¾“å‡º
    â”œâ”€â”€ conveyor_inspection_cli  # ä¸»ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶
    â”œâ”€â”€ hsv_tuner                # GUIè°ƒèŠ‚å·¥å…·
    â””â”€â”€ hsv_tuner_headless       # æ— GUIè°ƒèŠ‚å·¥å…·
```

## æ•…éšœæ’é™¤

### Q: çª—å£æ— æ³•æ˜¾ç¤ºï¼ŒæŠ¥é”™ "Can't initialize GTK backend"

**A:** OpenCV ä½¿ç”¨äº† GTK åç«¯ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ä½¿ç”¨ Qtï¼š
```bash
cd /home/serenNan/Tools/opencv/build
cmake -D WITH_QT=ON -D WITH_GTK=OFF ..
make -j$(nproc) && sudo make install
```
